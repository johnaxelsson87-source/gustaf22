<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Bambu &amp; Basics ‚Äì H√•llbara bambuplagg</title>
  <meta name="description" content="Enkel shopping f√∂r bambu-strumpor, T-shirts, underkl√§der och mer. Betala s√§kert med Swish ‚Äì h√•llbart och bekv√§mt!">
  <link rel="stylesheet" href="style.css">
  <!-- Google Analytics placeholder -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'GA_MEASUREMENT_ID');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span>Bambu &amp; Basics</div>
  </header>

  <section class="hero">
    <!-- Flytande knapp f√∂r att byta tema placerad i hero-avsnittet -->
    <button id="themeBtn" class="theme-toggle floating" aria-label="Byt till m√∂rkt tema">üåô</button>
    <div class="hero-content">
      <h1>Bambu &amp; Basics</h1>
      <p class="subtitle">H√•llbara bambuplagg f√∂r vardagen ‚Äì betala s√§kert med Swish</p>
      <button class="cta" onclick="scrollToProducts()">Se produkter</button>
    </div>
  </section>

  <section class="search-section">
    <div class="search-filters">
      <input id="search" class="search-input" type="text" placeholder="S√∂k produkter..." oninput="filterProducts()">
      <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterCategory(event, 'all')" aria-pressed="true">Alla</button>
        <button class="filter-btn" onclick="filterCategory(event, 'klader')" aria-pressed="false">Kl√§der</button>
        <button class="filter-btn" onclick="filterCategory(event, 'paket')" aria-pressed="false">Paket</button>
        <button class="filter-btn" onclick="filterCategory(event, 'accessoarer')" aria-pressed="false">Accessoarer</button>
      </div>
    </div>
  </section>

  <main id="product-grid" class="grid" role="main" aria-label="Produktlista">
    <!-- Produktkort -->
    <article class="card" data-category="klader" data-product="p1" tabindex="0">
      <img src="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Mjuka bambu-strumpor i 3-pack" loading="lazy">
      <div class="pad">
        <h3>Bambu-strumpor (3-pack)</h3>
        <div class="muted">Mjuka, andningsbara vardagsstrumpor.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r strumpor">
          <label for="p1-size">Storlek:</label>
          <select id="p1-size"><option>S</option><option>M</option><option>L</option></select>
          <label for="p1-color">F√§rg:</label>
          <select id="p1-color"><option>Vit</option><option>Gr√•</option></select>
        </div>
        <div class="stock" id="p1-stock">I lager: 20 st</div>
        <div class="price">149 kr</div>
        <div class="qtyrow">
          <label for="p1-qty" class="muted">Antal</label>
          <input class="qty" id="p1-qty" type="number" min="1" max="10" value="1" data-product="p1">
          <button class="buy" onclick="addToCart('p1', 149)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p2" tabindex="0">
      <img src="https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Sval bambu T-shirt" loading="lazy">
      <div class="pad">
        <h3>Bambu T-shirt</h3>
        <div class="muted">Sval och snabbtorkande i bambumix.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r T-shirt">
          <label for="p2-size">Storlek:</label>
          <select id="p2-size"><option>S</option><option>M</option><option>L</option><option>XL</option></select>
          <label for="p2-color">F√§rg:</label>
          <select id="p2-color"><option>Vit</option><option>Svart</option><option>Gr√∂n</option></select>
        </div>
        <div class="stock" id="p2-stock">I lager: 15 st</div>
        <div class="price">249 kr</div>
        <div class="qtyrow">
          <label for="p2-qty" class="muted">Antal</label>
          <input class="qty" id="p2-qty" type="number" min="1" max="10" value="1" data-product="p2">
          <button class="buy" onclick="addToCart('p2', 249)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="paket" data-product="p3" tabindex="0">
      <img src="https://images.unsplash.com/photo-1581655353564-df123a1eb820?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Bambu startkit med T-shirt och strumpor" loading="lazy">
      <div class="pad">
        <h3>Bambu startkit</h3>
        <div class="muted">1 T-shirt + 3-pack strumpor till rabattpris.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r startkit">
          <label for="p3-size">Storlek:</label>
          <select id="p3-size"><option>M</option><option>L</option></select>
          <label for="p3-color">F√§rg:</label>
          <select id="p3-color"><option>Gr√•</option></select>
        </div>
        <div class="stock" id="p3-stock">I lager: 8 st</div>
        <div class="price">399 kr</div>
        <div class="qtyrow">
          <label for="p3-qty" class="muted">Antal</label>
          <input class="qty" id="p3-qty" type="number" min="1" max="10" value="1" data-product="p3">
          <button class="buy" onclick="addToCart('p3', 399)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p4" tabindex="0">
      <img src="https://images.unsplash.com/photo-1581655353564-df123a1eb820?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Bekv√§ma bambu boxershorts i 2-pack" loading="lazy">
      <div class="pad">
        <h3>Bambu boxershorts (2-pack)</h3>
        <div class="muted">Bekv√§ma underbyxor med mjuk bambu.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r boxershorts">
          <label for="p4-size">Storlek:</label>
          <select id="p4-size"><option>M</option><option>L</option><option>XL</option></select>
          <label for="p4-color">F√§rg:</label>
          <select id="p4-color"><option>Svart</option><option>Gr√•</option></select>
        </div>
        <div class="stock" id="p4-stock">I lager: 12 st</div>
        <div class="price">179 kr</div>
        <div class="qtyrow">
          <label for="p4-qty" class="muted">Antal</label>
          <input class="qty" id="p4-qty" type="number" min="1" max="10" value="1" data-product="p4">
          <button class="buy" onclick="addToCart('p4', 179)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p5" tabindex="0">
      <img src="https://images.unsplash.com/photo-1593113598332-cd288d649433?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Varm bambu hoodie" loading="lazy">
      <div class="pad">
        <h3>Bambu hoodie</h3>
        <div class="muted">Varm och len hoodtr√∂ja f√∂r kyliga dagar.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r hoodie">
          <label for="p5-size">Storlek:</label>
          <select id="p5-size"><option>M</option><option>L</option><option>XL</option></select>
          <label for="p5-color">F√§rg:</label>
          <select id="p5-color"><option>Gr√•</option><option>Gr√∂n</option></select>
        </div>
        <div class="stock" id="p5-stock">I lager: 10 st</div>
        <div class="price">449 kr</div>
        <div class="qtyrow">
          <label for="p5-qty" class="muted">Antal</label>
          <input class="qty" id="p5-qty" type="number" min="1" max="10" value="1" data-product="p5">
          <button class="buy" onclick="addToCart('p5', 449)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p6" tabindex="0">
      <img src="https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="L√§tta bambu linnen i 3-pack" loading="lazy">
      <div class="pad">
        <h3>Bambu linnen (3-pack)</h3>
        <div class="muted">L√§tta undertr√∂jor f√∂r sommar och natt.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r linnen">
          <label for="p6-size">Storlek:</label>
          <select id="p6-size"><option>S</option><option>M</option><option>L</option><option>XL</option></select>
          <label for="p6-color">F√§rg:</label>
          <select id="p6-color"><option>Vit</option><option>Svart</option><option>Gr√•</option></select>
        </div>
        <div class="stock" id="p6-stock">I lager: 18 st</div>
        <div class="price">299 kr</div>
        <div class="qtyrow">
          <label for="p6-qty" class="muted">Antal</label>
          <input class="qty" id="p6-qty" type="number" min="1" max="10" value="1" data-product="p6">
          <button class="buy" onclick="addToCart('p6', 299)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p7" tabindex="0">
      <img src="https://images.unsplash.com/photo-1445205170230-053b83016050?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Slim-fit bambu chinos" loading="lazy">
      <div class="pad">
        <h3>Bambu chinos</h3>
        <div class="muted">Slim-fit byxor i bambumix f√∂r kontoret.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r chinos">
          <label for="p7-size">Storlek:</label>
          <select id="p7-size"><option>M</option><option>L</option><option>XL</option></select>
          <label for="p7-color">F√§rg:</label>
          <select id="p7-color"><option>Beige</option><option>Svart</option></select>
        </div>
        <div class="stock" id="p7-stock">I lager: 6 st</div>
        <div class="price">599 kr</div>
        <div class="qtyrow">
          <label for="p7-qty" class="muted">Antal</label>
          <input class="qty" id="p7-qty" type="number" min="1" max="10" value="1" data-product="p7">
          <button class="buy" onclick="addToCart('p7', 599)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="accessoarer" data-product="p8" tabindex="0">
      <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Milj√∂v√§nlig bambu ryggs√§ck" loading="lazy">
      <div class="pad">
        <h3>Bambu ryggs√§ck</h3>
        <div class="muted">Milj√∂v√§nlig v√§ska med bambufiber.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r ryggs√§ck">
          <label for="p8-size">Storlek:</label>
          <select id="p8-size"><option>Standard</option></select>
          <label for="p8-color">F√§rg:</label>
          <select id="p8-color"><option>Gr√∂n</option><option>Svart</option></select>
        </div>
        <div class="stock" id="p8-stock">I lager: 14 st</div>
        <div class="price">349 kr</div>
        <div class="qtyrow">
          <label for="p8-qty" class="muted">Antal</label>
          <input class="qty" id="p8-qty" type="number" min="1" max="10" value="1" data-product="p8">
          <button class="buy" onclick="addToCart('p8', 349)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="accessoarer" data-product="p9" tabindex="0">
      <img src="https://images.unsplash.com/photo-1551024506-cbf40702a8f2?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Snabbtorkande bambu handduk" loading="lazy">
      <div class="pad">
        <h3>Bambu handduk</h3>
        <div class="muted">Snabbtorkande badhandduk i bambu.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r handduk">
          <label for="p9-size">Storlek:</label>
          <select id="p9-size"><option>Standard</option></select>
          <label for="p9-color">F√§rg:</label>
          <select id="p9-color"><option>Bl√•</option></select>
        </div>
        <div class="stock" id="p9-stock">Slut i lager</div>
        <div class="price">199 kr</div>
        <div class="qtyrow">
          <label for="p9-qty" class="muted">Antal</label>
          <input class="qty" id="p9-qty" type="number" min="1" max="10" value="1" data-product="p9">
          <button class="buy" onclick="addToCart('p9', 199)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p10" tabindex="0">
      <img src="https://images.unsplash.com/photo-1560472354-b33c0c44a43?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Mjuk bambu morgonrock" loading="lazy">
      <div class="pad">
        <h3>Bambu morgonrock</h3>
        <div class="muted">Mjuk och varm f√∂r morgonrutinen.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r morgonrock">
          <label for="p10-size">Storlek:</label>
          <select id="p10-size"><option>L</option><option>XL</option></select>
          <label for="p10-color">F√§rg:</label>
          <select id="p10-color"><option>Vit</option><option>Gr√•</option></select>
        </div>
        <div class="stock" id="p10-stock">I lager: 7 st</div>
        <div class="price">499 kr</div>
        <div class="qtyrow">
          <label for="p10-qty" class="muted">Antal</label>
          <input class="qty" id="p10-qty" type="number" min="1" max="10" value="1" data-product="p10">
          <button class="buy" onclick="addToCart('p10', 499)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="klader" data-product="p11" tabindex="0">
      <img src="https://images.unsplash.com/photo-1602293589930-45aad31a38b5?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Antibakteriella bambu kalsonger i 5-pack" loading="lazy">
      <div class="pad">
        <h3>Bambu kalsonger (5-pack)</h3>
        <div class="muted">H√§lsosamma och antibakteriella underkl√§der.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r kalsonger">
          <label for="p11-size">Storlek:</label>
          <select id="p11-size"><option>S</option><option>M</option><option>L</option></select>
          <label for="p11-color">F√§rg:</label>
          <select id="p11-color"><option>Svart</option></select>
        </div>
        <div class="stock" id="p11-stock">I lager: 25 st</div>
        <div class="price">249 kr</div>
        <div class="qtyrow">
          <label for="p11-qty" class="muted">Antal</label>
          <input class="qty" id="p11-qty" type="number" min="1" max="10" value="1" data-product="p11">
          <button class="buy" onclick="addToCart('p11', 249)">L√§gg i korg</button>
        </div>
      </div>
    </article>

    <article class="card" data-category="paket" data-product="p12" tabindex="0">
      <img src="https://images.unsplash.com/photo-1542272604-787c3835532a?auto=format&amp;fit=crop&amp;w=800&amp;q=60" alt="Familjepaket med strumpor och T-shirts" loading="lazy">
      <div class="pad">
        <h3>Familjepaket</h3>
        <div class="muted">Strumpor + T-shirts f√∂r hela familjen.</div>
        <div class="variations" role="group" aria-label="Varianter f√∂r familjepaket">
          <label for="p12-size">Storlek:</label>
          <select id="p12-size"><option>Familj</option></select>
          <label for="p12-color">F√§rg:</label>
          <select id="p12-color"><option>Mix</option></select>
        </div>
        <div class="stock" id="p12-stock">I lager: 4 st</div>
        <div class="price">799 kr</div>
        <div class="qtyrow">
          <label for="p12-qty" class="muted">Antal</label>
          <input class="qty" id="p12-qty" type="number" min="1" max="10" value="1" data-product="p12">
          <button class="buy" onclick="addToCart('p12', 799)">L√§gg i korg</button>
        </div>
      </div>
    </article>
  </main>

  <aside id="cart" class="cart" aria-hidden="true">
    <h3>Varukorg</h3>
    <ul id="cart-items"></ul>
    <div class="total-row">Totalt: <span id="total">0</span> kr</div>
    <div class="discount-row">
      <input id="discount" type="text" placeholder="Rabattkod (t.ex. JUL10)">
      <button onclick="applyDiscount()">L√∂s in</button>
    </div>
    <div class="cart-actions">
      <button class="checkout-btn" onclick="checkout()">Till betalning</button>
      <button class="clear-btn" onclick="clearCart()">T√∂m korg</button>
    </div>
  </aside>

  <div id="swishModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Swish-betalning</h3>
      <p>Belopp: <span id="modal-amount"></span> kr</p>
      <p>Mottagare: <span id="swish-payee"></span></p>
      <p>Referens: <span id="order-ref"></span> <button class="small-btn" onclick="copyRef()">Kopiera</button></p>
      <div id="qr-code"></div>
      <textarea id="customer-note" placeholder="L√§gg till en notering (frivilligt)" rows="3"></textarea>
      <button class="small-btn" onclick="sendEmail()">Skicka notering</button>
      <div class="modal-actions">
        <button class="primary" onclick="openSwish()">√ñppna Swish</button>
        <button class="primary" onclick="generateReceipt()">Kopiera kvitto</button>
        <button class="secondary" onclick="closeModal()">St√§ng</button>
      </div>
    </div>
  </div>

  <section class="contact-section">
    <h2>Kontakt</h2>
    <form id="contactForm" onsubmit="handleContact(event)">
      <input id="contactName" type="text" placeholder="Namn">
      <input id="contactEmail" type="email" placeholder="E-post">
      <textarea id="contactMessage" placeholder="Meddelande"></textarea>
      <button type="submit">Skicka</button>
    </form>
  </section>

  <footer>
    <p>F√∂retag: Exempel AB, Org.nr: 123456-7890, Adress: Gata 1, 12345 Stockholm | Mail: info@exempel.se</p>
    <p><a href="#">√Öngerr√§tt 14 dagar</a> | <a href="#">Integritetspolicy</a></p>
  </footer>

  <div id="cookie-banner" class="cookie-banner" aria-hidden="true">
    <p>Vi anv√§nder localStorage f√∂r varukorgen.</p>
    <button onclick="acceptCookies()">OK</button>
  </div>

  <script>
    // Konstanter och init
    const SWISH_PAYEE = "1231231231"; // BYT TILL ERT NUMMER
    const EMAILJS_SERVICE_ID = "service_g88v65c"; // Ditt Service ID
    const EMAILJS_TEMPLATE_ID = "template_zrpuoqk"; // Ditt Template ID
    const EMAILJS_PUBLIC_KEY = "1f-ac3e7g3AzForKR"; // Byt till ditt User ID (t.ex. user_abc123)
    let cart = JSON.parse(localStorage.getItem('cart')) || {};
    let discount = 0;
    let currentFilter = 'all';
    const stockData = { p1: 20, p2: 15, p3: 8, p4: 12, p5: 10, p6: 18, p7: 6, p8: 14, p9: 0, p10: 7, p11: 25, p12: 4 };
    const prices = { p1: 149, p2: 249, p3: 399, p4: 179, p5: 449, p6: 299, p7: 599, p8: 349, p9: 199, p10: 499, p11: 249, p12: 799 };
    const productTitles = { p1: 'Bambu-strumpor (3-pack)', p2: 'Bambu T-shirt', p3: 'Bambu startkit', p4: 'Bambu boxershorts (2-pack)', p5: 'Bambu hoodie', p6: 'Bambu linnen (3-pack)', p7: 'Bambu chinos', p8: 'Bambu ryggs√§ck', p9: 'Bambu handduk', p10: 'Bambu morgonrock', p11: 'Bambu kalsonger (5-pack)', p12: 'Familjepaket' };

    // EmailJS init
    emailjs.init(EMAILJS_PUBLIC_KEY);

    // Tema (dark mode) med systempreferens
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.body.dataset.theme = theme;
      document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('themeBtn').setAttribute('aria-label', theme === 'dark' ? 'Byt till ljust tema' : 'Byt till m√∂rkt tema');
    }
    function toggleTheme() {
      const current = document.body.dataset.theme;
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.body.dataset.theme = newTheme;
      localStorage.setItem('theme', newTheme);
      document.getElementById('themeBtn').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('themeBtn').setAttribute('aria-label', newTheme === 'dark' ? 'Byt till ljust tema' : 'Byt till m√∂rkt tema');
    }
    document.getElementById('themeBtn').addEventListener('click', toggleTheme);
    initTheme();

    // Dynamisk lagerhantering
    function updateStockDisplay() {
      Object.keys(stockData).forEach(id => {
        const stockEl = document.getElementById(`${id}-stock`);
        const qtyEl = document.getElementById(`${id}-qty`);
        const buyBtn = document.querySelector(`button[onclick="addToCart('${id}', ${prices[id]})"]`);
        const selects = document.querySelectorAll(`#${id}-size, #${id}-color`);
        if (stockEl && buyBtn) {
          if (stockData[id] === 0) {
            stockEl.textContent = 'Slut i lager';
            stockEl.classList.add('out-of-stock');
            qtyEl.disabled = true;
            buyBtn.disabled = true;
            buyBtn.textContent = 'Slut i lager';
            selects.forEach(s => s.disabled = true);
          } else {
            stockEl.textContent = `I lager: ${stockData[id]} st`;
            stockEl.classList.remove('out-of-stock');
            qtyEl.disabled = false;
            buyBtn.disabled = false;
            buyBtn.textContent = 'L√§gg i korg';
            selects.forEach(s => s.disabled = false);
          }
        }
      });
    }
    updateStockDisplay();

    // S√∂k och filter
    function filterProducts() {
      const query = document.getElementById('search').value.toLowerCase();
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        const title = card.querySelector('h3').textContent.toLowerCase();
        const desc = card.querySelector('.muted').textContent.toLowerCase();
        const matchesSearch = !query || title.includes(query) || desc.includes(query);
        const matchesFilter = currentFilter === 'all' || card.dataset.category === currentFilter;
        card.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
        card.setAttribute('aria-hidden', (matchesSearch && matchesFilter) ? 'false' : 'true');
      });
    }
    function filterCategory(event, cat) {
      currentFilter = cat;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
      });
      event.target.classList.add('active');
      event.target.setAttribute('aria-pressed', 'true');
      filterProducts();
    }

    // Scroll till produkter
    function scrollToProducts() {
      document.getElementById('product-grid').scrollIntoView({ behavior: 'smooth' });
    }

    // Varukorg
    function addToCart(id, price) {
      const qtyInput = document.getElementById(`${id}-qty`);
      if (!qtyInput) {
        console.error('Qty input saknas f√∂r produkt ' + id);
        return;
      }
      const qty = parseInt(qtyInput.value) || 1;
      if (qty <= 0) {
        alert('V√§lj minst 1!');
        return;
      }
      if (qty > stockData[id]) {
        alert(`Inte tillr√§ckligt i lager! Max ${stockData[id]} st.`);
        return;
      }
      if (qty > 10) {
        alert('Max 10 st per produkt!');
        return;
      }
      const size = document.getElementById(`${id}-size`).value;
      const color = document.getElementById(`${id}-color`).value;
      cart[id] = { qty, price, size, color, title: productTitles[id] || id };
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
      gtag('event', 'add_to_cart', { item_id: id, item_quantity: qty });
      qtyInput.value = 1;
    }
    function updateCart() {
      const cartEl = document.getElementById('cart');
      const itemsEl = document.getElementById('cart-items');
      const totalEl = document.getElementById('total');
      let total = 0;
      let productsList = '';
      itemsEl.innerHTML = '';
      for (let id in cart) {
        if (!cart.hasOwnProperty(id)) continue;
        const item = cart[id];
        const li = document.createElement('li');
        li.innerHTML = `${item.title || id} (${item.size}, ${item.color}): ${item.qty} x ${item.price} kr <button onclick="removeFromCart('${id}')">Ta bort</button>`;
        itemsEl.appendChild(li);
        total += item.qty * item.price;
        productsList += `${item.title || id} x${item.qty} (${item.size}, ${item.color}) ‚Äì ${item.qty * item.price} kr; `;
      }
      total = Math.round(total * (1 - discount));
      totalEl.textContent = total;
      cartEl.style.display = Object.keys(cart).length ? 'block' : 'none';
      cartEl.setAttribute('aria-hidden', Object.keys(cart).length ? 'false' : 'true');
      window.productsList = productsList;
      window.totalForMail = total;
    }
    function removeFromCart(id) {
      delete cart[id];
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }
    function applyDiscount() {
      const code = document.getElementById('discount').value.trim().toUpperCase();
      discount = code === 'JUL10' ? 0.1 : 0;
      updateCart();
      if (discount > 0) gtag('event', 'promo_code_applied', { promo_code: code });
    }
    function clearCart() {
      if (confirm('T√∂m korgen?')) {
        cart = {};
        localStorage.removeItem('cart');
        updateCart();
      }
    }
    updateCart();

    // EmailJS helpers
    function sendConfirmationEmail(orderId, total, note) {
      const templateParams = {
        to_email: 'johnaxelsson87@gmail.com',
        orderId: orderId,
        total: total,
        products: window.productsList || 'Inga produkter',
        swishRef: orderId,
        note: note || 'Ingen notering',
        date: new Date().toLocaleString('sv-SE')
      };
      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
        .then((response) => {
          console.log('Mail skickad OK!', response.status, response.text);
        }, (error) => {
          console.error('EmailJS-fel:', error);
          alert(`Fel vid mail: ${error.text || 'Kontrollera verifiering i EmailJS-dashboarden.'}\nSe konsolen f√∂r mer info.`);
        });
    }

    function checkout() {
      if (!Object.keys(cart).length) {
        alert('Korgen √§r tom!');
        return;
      }
      const total = parseInt(document.getElementById('total').textContent);
      const orderId = 'ORD-' + Date.now();
      document.getElementById('modal-amount').textContent = total;
      document.getElementById('swish-payee').textContent = SWISH_PAYEE;
      document.getElementById('order-ref').textContent = orderId;
      document.getElementById('swishModal').style.display = 'flex';
      document.getElementById('swishModal').setAttribute('aria-hidden', 'false');

      const qrData = `swish://payment?payee=${SWISH_PAYEE}&amount=${total * 100}&message=${orderId}`;
      const qrEl = document.getElementById('qr-code');
      qrEl.innerHTML = '';
      QRCode.toCanvas(qrEl, qrData, { width: 200, errorCorrectionLevel: 'H' }, (error) => {
        if (error) {
          console.error('QR-fel:', error);
          qrEl.innerHTML = '<p>QR-kod kunde inte genereras.</p>';
        }
      });

      sendConfirmationEmail(orderId, total, '');
      setTimeout(closeModal, 30000);
      gtag('event', 'begin_checkout', { value: total });
    }

    function closeModal() {
      document.getElementById('swishModal').style.display = 'none';
      document.getElementById('swishModal').setAttribute('aria-hidden', 'true');
      gtag('event', 'checkout_abandon');
    }
    function openSwish() {
      const amount = parseInt(document.getElementById('modal-amount').textContent);
      const ref = document.getElementById('order-ref').textContent;
      window.location.href = `swish://payment?payee=${SWISH_PAYEE}&amount=${amount * 100}&message=${ref}`;
      gtag('event', 'purchase', { value: amount, transaction_id: ref });
    }
    function copyRef() {
      const ref = document.getElementById('order-ref').textContent;
      navigator.clipboard.writeText(ref).then(() => alert('Referens kopierad!'));
    }
    function generateReceipt() {
      const amount = document.getElementById('modal-amount').textContent;
      const ref = document.getElementById('order-ref').textContent;
      const receipt = `Kvitto\nBelopp: ${amount} kr\nReferens: ${ref}\nTack f√∂r ditt k√∂p!`;
      navigator.clipboard.writeText(receipt).then(() => alert('Kvitto kopierat!'));
    }
    function sendEmail() {
      const note = document.getElementById('customer-note').value || 'Ingen notering';
      const orderId = document.getElementById('order-ref').textContent;
      const total = parseInt(document.getElementById('modal-amount').textContent);
      sendConfirmationEmail(orderId, total, note);
    }

    // Kontaktformul√§r
    function handleContact(event) {
      event.preventDefault();
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      if (!name || !email || !message) {
        alert('Fyll i alla f√§lt!');
        return;
      }
      console.log('Kontakt:', { name, email, message });
      alert('Tack! Meddelandet √§r skickat.');
      document.getElementById('contactForm').reset();
      gtag('event', 'contact_form_submit');
    }

    // Cookies
    if (!localStorage.getItem('cookiesAccepted')) {
      document.getElementById('cookie-banner').style.display = 'flex';
    }
    function acceptCookies() {
      localStorage.setItem('cookiesAccepted', 'true');
      document.getElementById('cookie-banner').style.display = 'none';
    }

    // Analytics f√∂r produktvisning
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const cards = document.querySelectorAll('.card:not([aria-hidden="true"])');
        cards.forEach(card => {
          if (isInViewport(card) && !card.dataset.viewed) {
            const id = card.dataset.product;
            gtag('event', 'view_item', { item_id: id });
            card.dataset.viewed = 'true';
          }
        });
      }, 100);
    });
    function isInViewport(el) {
      const rect = el.getBoundingClientRect();
      return rect.top < window.innerHeight * 0.75 && rect.bottom > 0;
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const buyBtn = card.querySelector('.buy:not(:disabled)');
          if (buyBtn) buyBtn.click();
        }
      });
    });
  </script>
</body>
</html>
